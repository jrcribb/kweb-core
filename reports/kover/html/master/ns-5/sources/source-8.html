


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > OnReceiverKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">kweb.html.events</a>
</div>

<h1>Coverage Summary for Class: OnReceiverKt (kweb.html.events)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">OnReceiverKt</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
</tr>
  <tr>
    <td class="name">OnReceiverKt$logger$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package kweb.html.events
&nbsp;
&nbsp;import kotlinx.coroutines.flow.asFlow
&nbsp;import kotlinx.serialization.json.*
&nbsp;import kotlinx.serialization.serializer
&nbsp;import kweb.WebBrowser
&nbsp;import kweb.util.KWebDSL
&nbsp;import mu.KotlinLogging
&nbsp;import java.util.Collections.emptySet
&nbsp;import java.util.concurrent.ConcurrentHashMap
&nbsp;import kotlin.reflect.KClass
&nbsp;import kotlin.reflect.full.memberProperties
&nbsp;
<b class="pc">&nbsp;@PublishedApi internal val logger = KotlinLogging.logger {}</b>
&nbsp;
&nbsp;@KWebDSL
&nbsp;class OnReceiver&lt;T : EventGenerator&lt;T&gt;&gt;(val source: T, private val retrieveJs: String? = null, val preventDefault : Boolean) {
&nbsp;
&nbsp;    fun event(eventName: String, returnEventFields: Set&lt;String&gt; = emptySet(), callback: (event: JsonElement) -&gt; Unit): T {
&nbsp;        source.addEventListener(eventName, returnEventFields = returnEventFields,
&nbsp;                callback = { callback(it) }, retrieveJs = retrieveJs, preventDefault = preventDefault)
&nbsp;        return source
&nbsp;    }
&nbsp;
&nbsp;    inline fun &lt;reified U : Any&gt; event(eventName: String, crossinline callback: (event: U) -&gt; Unit): T {
&nbsp;        // TODO: Should probably cache this rather than do the reflection every time
&nbsp;        val eventPropertyNames = memberProperties(U::class)
&nbsp;
&nbsp;        val serializer = serializer&lt;U&gt;()
&nbsp;        return event(eventName, eventPropertyNames) { propertiesAsElement -&gt;
&nbsp;            if (propertiesAsElement == JsonNull) {
&nbsp;                /*
&nbsp;                 * Couldn&#39;t figure out why this was happening, but it doesn&#39;t appear to have any
&nbsp;                 * negative effect. TODO: Figure out why it&#39;s happening and fix
&nbsp;                 */
&nbsp;                logger.warn { &quot;Received event callback with JsonNull where data is expected, disregarding&quot; }
&nbsp;            } else {
&nbsp;                val props = Json.decodeFromJsonElement(serializer, propertiesAsElement)
&nbsp;                try {
&nbsp;                    if (source.browser.isCatchingOutbound() == null) {
&nbsp;                        source.browser.batch(WebBrowser.CatcherType.EVENT) {
&nbsp;                            callback(props)
&nbsp;                        }
&nbsp;                    } else {
&nbsp;                        callback(props)
&nbsp;                    }
&nbsp;                } catch (e: Exception) {
&nbsp;                    logger.error(e) { &quot;Exception thrown by callback in response to $eventName event&quot; }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    companion object {
&nbsp;        val memberPropertiesCache: ConcurrentHashMap&lt;KClass&lt;*&gt;, Set&lt;String&gt;&gt; = ConcurrentHashMap()
&nbsp;        inline fun &lt;reified T : Any&gt; memberProperties(clazz: KClass&lt;T&gt;) =
&nbsp;                memberPropertiesCache[clazz]
&nbsp;                        ?: T::class.memberProperties.map { it.name }.toSet().minus(&quot;retrieved&quot;).also { memberPropertiesCache.put(clazz, it) }
&nbsp;    }
&nbsp;
&nbsp;    // Mouse events
&nbsp;    fun click(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;click&quot;, callback = callback)
&nbsp;    fun contextmenu(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;contextmenu&quot;, callback = callback)
&nbsp;    fun dblclick(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;dblclick&quot;, callback = callback)
&nbsp;    fun mousedown(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mousedown&quot;, callback = callback)
&nbsp;    fun mouseenter(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mouseenter&quot;, callback = callback)
&nbsp;    fun mouseleave(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mouseleave&quot;, callback = callback)
&nbsp;    fun mousemove(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mousemove&quot;, callback = callback)
&nbsp;    fun mouseover(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mouseover&quot;, callback = callback)
&nbsp;    fun mouseout(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mouseout&quot;, callback = callback)
&nbsp;    fun mouseup(callback: (event: MouseEvent) -&gt; Unit) = event(&quot;mouseup&quot;, callback = callback)
&nbsp;
&nbsp;    // Keyboard events
&nbsp;    fun keydown(callback: (event: KeyboardEvent) -&gt; Unit) = event(&quot;keydown&quot;, callback = callback)
&nbsp;    fun keypress(callback: (event: KeyboardEvent) -&gt; Unit) = event(&quot;keypress&quot;, callback = callback)
&nbsp;    fun keyup(callback: (event: KeyboardEvent) -&gt; Unit) = event(&quot;keyup&quot;, callback = callback)
&nbsp;
&nbsp;    // Focus Events TODO: define event types
&nbsp;    // https://www.w3schools.com/jsref/obj_focusevent.asp
&nbsp;    fun blur(callback: (event: Event) -&gt; Unit) = event(&quot;blur&quot;,  callback = callback)
&nbsp;    fun focus(callback: (event: Event) -&gt; Unit) = event(&quot;focus&quot;,  callback = callback)
&nbsp;    fun focusin(callback: (event: Event) -&gt; Unit) = event(&quot;focusin&quot;,  callback = callback)
&nbsp;    fun focusout(callback: (event: Event) -&gt; Unit) = event(&quot;focusout&quot;,  callback = callback)
&nbsp;
&nbsp;    // Frame / Object Events TODO: define eventtype
&nbsp;    fun abort(callback: (event: Event) -&gt; Unit) = event(&quot;abort&quot;,  callback = callback)
&nbsp;    fun beforeunload(callback: (event: Event) -&gt; Unit) = event(&quot;beforeunload&quot;,  callback = callback)
&nbsp;    fun error(callback: (event: Event) -&gt; Unit) = event(&quot;error&quot;,  callback = callback)
&nbsp;    fun hashchange(callback: (event: Event) -&gt; Unit) = event(&quot;hashchange&quot;,  callback = callback)
&nbsp;    fun load(callback: (event: Event) -&gt; Unit) = event(&quot;load&quot;,  callback = callback)
&nbsp;    fun pageshow(callback: (event: Event) -&gt; Unit) = event(&quot;pageshow&quot;,  callback = callback)
&nbsp;    fun pagehide(callback: (event: Event) -&gt; Unit) = event(&quot;pagehide&quot;,  callback = callback)
&nbsp;    fun resize(callback: (event: Event) -&gt; Unit) = event(&quot;resize&quot;,  callback = callback)
&nbsp;    fun scroll(callback: (event: Event) -&gt; Unit) = event(&quot;scroll&quot;,  callback = callback)
&nbsp;    fun unload(callback: (event: Event) -&gt; Unit) = event(&quot;unload&quot;,  callback = callback)
&nbsp;
&nbsp;    // Form Events TODO: define eventtypes
&nbsp;    fun change(callback: (event: Event) -&gt; Unit) = event(&quot;change&quot;,  callback = callback)
&nbsp;    fun input(callback: (event: Event) -&gt; Unit) = event(&quot;input&quot;,  callback = callback)
&nbsp;    fun invalid(callback: (event: Event) -&gt; Unit) = event(&quot;invalid&quot;,  callback = callback)
&nbsp;    fun reset(callback: (event: Event) -&gt; Unit) = event(&quot;reset&quot;,  callback = callback)
&nbsp;    fun search(callback: (event: Event) -&gt; Unit) = event(&quot;search&quot;,  callback = callback)
&nbsp;    fun select(callback: (event: Event) -&gt; Unit) = event(&quot;select&quot;,  callback = callback)
&nbsp;    fun submit(callback: (event: Event) -&gt; Unit) = event(&quot;submit&quot;,  callback = callback)
&nbsp;
&nbsp;    // Drag Events TODO: define eventtype
&nbsp;    fun drag(callback: (event: Event) -&gt; Unit) = event(&quot;drag&quot;,  callback = callback)
&nbsp;    fun dragend(callback: (event: Event) -&gt; Unit) = event(&quot;dragend&quot;,  callback = callback)
&nbsp;    fun dragenter(callback: (event: Event) -&gt; Unit) = event(&quot;dragenter&quot;,  callback = callback)
&nbsp;    fun dragleave(callback: (event: Event) -&gt; Unit) = event(&quot;dragleave&quot;,  callback = callback)
&nbsp;    fun dragover(callback: (event: Event) -&gt; Unit) = event(&quot;dragover&quot;,  callback = callback)
&nbsp;    fun dragstart(callback: (event: Event) -&gt; Unit) = event(&quot;dragstart&quot;,  callback = callback)
&nbsp;    fun drop(callback: (event: Event) -&gt; Unit) = event(&quot;drop&quot;,  callback = callback)
&nbsp;
&nbsp;    // Clipboard Events TODO: define eventtype
&nbsp;    fun copy(callback: (event: Event) -&gt; Unit) = event(&quot;copy&quot;,  callback = callback)
&nbsp;    fun cut(callback: (event: Event) -&gt; Unit) = event(&quot;cut&quot;,  callback = callback)
&nbsp;    fun paste(callback: (event: Event) -&gt; Unit) = event(&quot;paste&quot;,  callback = callback)
&nbsp;
&nbsp;    // Print Events TODO: define eventtype
&nbsp;    fun afterprint(callback: (event: Event) -&gt; Unit) = event(&quot;afterprint&quot;,  callback = callback)
&nbsp;    fun beforeprint(callback: (event: Event) -&gt; Unit) = event(&quot;beforeprint&quot;,  callback = callback)
&nbsp;
&nbsp;    // Selection Events TODO: define eventtype
&nbsp;    fun selectstart(callback: (event: Event) -&gt; Unit) = event(&quot;selectstart&quot;,  callback = callback)
&nbsp;    fun selectionchange(callback: (event: Event) -&gt; Unit) = event(&quot;selectionchange&quot;,  callback = callback)
&nbsp;
&nbsp;    // Window events
&nbsp;    fun popstate(callback: (event: Event) -&gt; Unit) = event(&quot;popstate&quot;,  callback = callback)
&nbsp;
&nbsp;
&nbsp;    /*
&nbsp;    // Media Events TODO: define eventtype
&nbsp;    fun abort(callback: (event: Event) -&gt; Unit) = event(&quot;abort&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser can start playing the media (when it has buffered enough to begin) **/
&nbsp;    fun canplay(callback: (event: Event) -&gt; Unit) = event(&quot;canplay&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser can play through the media without stopping for buffering **/
&nbsp;    fun canplaythrough(callback: (event: Event) -&gt; Unit) = event(&quot;canplaythrough&quot;,  callback = callback)
&nbsp;    /** The event occurs when the duration of the media is changed **/
&nbsp;    fun durationchange(callback: (event: Event) -&gt; Unit) = event(&quot;durationchange&quot;,  callback = callback)
&nbsp;    /** The event occurs when something bad happens and the media file is suddenly unavailable (like unexpectedly disconnects) **/
&nbsp;    fun emptied(callback: (event: Event) -&gt; Unit) = event(&quot;emptied&quot;,  callback = callback)
&nbsp;    /** The event occurs when the media has reach the end (useful for messages like &quot;thanks for listening&quot;) **/
&nbsp;    fun ended(callback: (event: Event) -&gt; Unit) = event(&quot;ended&quot;,  callback = callback)
&nbsp;    /** The event occurs when an message occurred during the loading of a media file **/
&nbsp;    fun message(callback: (event: Event) -&gt; Unit) = event(&quot;message&quot;,  callback = callback)
&nbsp;    /** The event occurs when media data is loaded **/
&nbsp;    fun loadeddata(callback: (event: Event) -&gt; Unit) = event(&quot;loadeddata&quot;,  callback = callback)
&nbsp;    /** The event occurs when meta data (like dimensions and duration) are loaded **/
&nbsp;    fun loadedmetadata(callback: (event: Event) -&gt; Unit) = event(&quot;loadedmetadata&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser starts looking for the specified media **/
&nbsp;    fun loadstart(callback: (event: Event) -&gt; Unit) = event(&quot;loadstart&quot;,  callback = callback) /** The event occurs when the media is paused either by the user or programmatically **/
&nbsp;    fun pause(callback: (event: Event) -&gt; Unit) = event(&quot;pause&quot;,  callback = callback)
&nbsp;    /** The event occurs when the media has been started or is no longer paused **/
&nbsp;    fun play(callback: (event: Event) -&gt; Unit) = event(&quot;play&quot;,  callback = callback)
&nbsp;    /** The event occurs when the media is playing after having been paused or stopped for buffering **/
&nbsp;    fun playing(callback: (event: Event) -&gt; Unit) = event(&quot;playing&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser is in the process of getting the media data (downloading the media) **/
&nbsp;    fun progress(callback: (event: Event) -&gt; Unit) = event(&quot;progress&quot;,  callback = callback)
&nbsp;    /** The event occurs when the playing speed of the media is changed **/
&nbsp;    fun ratechange(callback: (event: Event) -&gt; Unit) = event(&quot;ratechange&quot;,  callback = callback)
&nbsp;    /** The event occurs when the user is finished moving/skipping to a new position in the media **/
&nbsp;    fun seeked(callback: (event: Event) -&gt; Unit) = event(&quot;seeked&quot;,  callback = callback)
&nbsp;    /** The event occurs when the user starts moving/skipping to a new position in the media **/
&nbsp;    fun seeking(callback: (event: Event) -&gt; Unit) = event(&quot;seeking&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser is trying to get media data, but data is not available **/
&nbsp;    fun stalled(callback: (event: Event) -&gt; Unit) = event(&quot;stalled&quot;,  callback = callback)
&nbsp;    /** The event occurs when the browser is intentionally not getting media data **/
&nbsp;    fun suspend(callback: (event: Event) -&gt; Unit) = event(&quot;suspend&quot;,  callback = callback)
&nbsp;    /** The event occurs when the playing position has changed (like when the user fast forwards to a different point in the media) **/
&nbsp;    fun timeupdate(callback: (event: Event) -&gt; Unit) = event(&quot;timeupdate&quot;,  callback = callback)
&nbsp;    /** The event occurs when the volume of the media has changed (includes setting the volume to &quot;mute&quot;) **/
&nbsp;    fun volumechange(callback: (event: Event) -&gt; Unit) = event(&quot;volumechange&quot;,  callback = callback)
&nbsp;    /** The event occurs when the media has paused but is expected to resume (like when the media pauses to buffer more data) **/
&nbsp;    fun waiting(callback: (event: Event) -&gt; Unit) = event(&quot;waiting&quot;,  callback = callback)
&nbsp;    */
&nbsp;
&nbsp;    /** TODO: Add more to https://www.w3schools.com/jsref/dom_obj_event.asp
&nbsp;     * Missing:
&nbsp;     * * Server-Sent Events
&nbsp;     * * Misc Events
&nbsp;     * * Touch Events
&nbsp;     * *
&nbsp;     */
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-12-01 22:26</div>
</div>
</body>
</html>
